---
title: "Football statistics dashboard"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
runtime: shiny
---

<style>
  .center-text {
    text-align: center;
  }
</style>

<div class="center-text">
  The best interactive dashboard on the market with statistics about football in the top 5 leagues
</div>


```{r setup, include = FALSE}
library(flexdashboard) 
library(tidyverse)
library(ggrepel)
library(DT)
library(shiny)
#knitr::opts_chunk$set(fig.width = 5)


#read the data
data1 <- read_csv(file = "data/understat_per_game.csv")
data2 <- read_csv(file = "data/understat.com.csv")

colnames_1 = c("league", "year", "stadium", "exp_goal", "exp_goal_against", 
               "no_pen_exp_goal", "no_pen_exp_goal_against", "deep", 
               "deep_allowed", "scored", "conceded", "exp_pts", "result", "date", 
               "wins", "draws", "loses", "pts", "no_pen_exp_goal_diff", "ppda_coef", 
               "ppda_att", "ppda_def", "oppda_coef", "oppda_att", "oppda_def", 
               "team", "exp_goal_diff", "exp_goal_against_diff", 
               "exp_pts_diff")

colnames(data1) = colnames_1

colnames_2 = c("league", "year", "position", "team", "matches", "wins", "draws", 
               "loses", "scored", "conceded", "pts", "exp_goal", "exp_goal_diff", 
               "no_pen_exp_goal", "exp_goal_against", "exp_goal_against_diff", 
               "no_pen_exp_goal_against", 
               "no_pen_exp_goal_diff", "ppda_coef", "oppda_coef", "deep", 
               "deep_allowed", "exp_pts", "exp_pts_diff")

colnames(data2) = colnames_2

data_per_game <- data1 |> 
  mutate("stadium" = as.factor(stadium), 
         "result" = as.factor(result), 
         "league" = as.factor(league),
         "pts" = as.factor(pts)) |> 
  filter(league != "RFPL")

data_per_club <- data2 |> 
  filter(league != "RFPL") |> 
  mutate("goal_diff" = scored - conceded)

## Check to see no duplicates and the pairing of opponent is done correctly on a 1-1 basis
length(data_per_game$league[duplicated(cbind(data_per_game$league, 
                                             data_per_game$year, 
                                             data_per_game$date, 
                                             data_per_game$scored, 
                                             data_per_game$conceded, 
                                             data_per_game$exp_goal_against, 
                                             data_per_game$exp_goal, 
                                             data_per_game$ppda_coef, 
                                             data_per_game$oppda_coef))])

## Link opponents to each respective match
temp_opponents = data_per_game |> select(league, year, date, scored, 
                                         conceded, exp_goal_against, exp_goal, 
                                         ppda_coef, oppda_coef, "opponent" = team)

data_per_game = data_per_game |> 
  left_join(temp_opponents, by = c("league" = "league", "year" = "year", 
                                   "date" = "date", "scored" = "conceded", 
                                   "conceded" = "scored", 
                                   "exp_goal_against" = "exp_goal", 
                                   "exp_goal" = "exp_goal_against", 
                                   "ppda_coef" = "oppda_coef", 
                                   "oppda_coef" = "ppda_coef"))


```





Team {data-icon="fa-futbol" data-orientation=rows}
==========================


Options {.sidebar}
------------------------

```{r}


selectInput("season", "Choose a competition:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1" 
                  ))

```

```{r}

selectInput("team_year", "Choose a season:",
                c("2014-2015" = "2014",
                  "2015-2016" = "2015",
                  "2016-2017" = "2016",
                  "2017-2018" = "2017", 
                  "2018-2019" = "2018", 
                  "2019-2020" = "2019"))

```

```{r}

teams = reactive({return(sort(filter(data_per_club, league == input$team_league, year == input$team_year)$team))})

teams_opp = reactive({return(sort(filter(data_per_club, league == input$team_league, year == input$team_year, team != input$team_team)$team))})

#renderTable(filter(data_per_club, league == input$team_league, year == input$team_year)$team)

#reactiveValuesToList(teams)
##teams_final = c()
#reactive({
#  teams_final = c()
#  for (i in teams()){
#    teams_final = cbind(teams_final, i)
#  }
#  selectInput("team_team", "Choose a team:", teams_final)
#})

#print(str(teams_final))


selectInput("team_team", "Choose a team:", c(""))

selectInput("team_opp", "Choose a team for Head to Head comparison:", c(""))

#actionButton("prueba", "Probando")

#equipo = reactive(input$team_team)
#anio = reactive(input$team_year)
#liga = reactive(input$team_league)

#reactive(print(input$team_team))

#observeEvent(input$prueba, renderPrint(anio(), liga()))

#,warning = FALSE,results='hide'
reactive(updateSelectInput(inputId = "team_team", choices = teams()))

reactive(updateSelectInput(inputId = "team_opp", choices = teams_opp()))

#position = reactive(as.character(filter(data_per_club, league == input$team_league, year == input$team_year, team = input$team_team)$position[1]))

#renderTable(filter(data_per_club, league == input$team_league, year == input$team_year, team = input$team_team)$position[1])

```




tabset
-----------------------------------

### tab1 

Here we can see the main statistics for the team (insert team name) and their historic results against team (insert opponents name)


row
---------------------------

### Final Position
```{r fig.width=1, fig.height=0.5}

renderValueBox({
  position = filter(data_per_club, league == input$team_league, year == input$team_year, team == input$team_team)$position[1]
  
  box_icon = ""
  
  if(position == 1){
    box_icon = "ion-trophy"
  } else if(position <= 3){
    box_icon = "ion-ribbon-a"
  } else if(position <= 10){
    box_icon = "ion-android-happy"
  } else{
    box_icon = "ion-android-sad"
  }
  
  valueBox(value = position, icon = box_icon)
})

```

### Matches Won
```{r fig.width=1, fig.height=1}

renderGauge({
  matches_played = filter(data_per_club, league == input$team_league, year == input$team_year, team == input$team_team)$matches
  matches_won = filter(data_per_club, league == input$team_league, year == input$team_year, team == input$team_team)$wins
  
  gauge(matches_won, min = 0, max = matches_played, gaugeSectors(
  success = c(2*matches_played/3, matches_played), warning = c(matches_played/3, 2*matches_played/3), danger = c(0, matches_played/3), colors = c("mediumseagreen", "palegoldenrod", "lightcoral")))
})

```
> number of matches won played at "home" and "away" (separate in home and away?)

### Matches Lost
```{r fig.width=1, fig.height=1}

renderGauge({
  matches_played = filter(data_per_club, league == input$team_league, year == input$team_year, team == input$team_team)$matches
  matches_lost = filter(data_per_club, league == input$team_league, year == input$team_year, team == input$team_team)$loses
  
  gauge(matches_lost, min = 0, max = matches_played, gaugeSectors(
  success = c(2*matches_played/3, matches_played), warning = c(matches_played/3, 2*matches_played/3), danger = c(0, matches_played/3), colors = c("lightcoral", "palegoldenrod", "mediumseagreen")))
})

```
> number of matches lost played at "home" and "away" (separate in home and away?)
> CAMBIAR, DIVIDIR wins looses in home and away!!!

### je ne sais pas
```{r fig.width=1, fig.height=1}

gauge(18, min = 0, max = 38, gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)))

```
> the most important summary statistics for the season

### io non posso idea
```{r fig.width=1, fig.height=1}

gauge(18, min = 0, max = 38, gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)))

```

> the most important summary statistics for the season

row
----------------------------------

### Head to Head 

```{r}

renderTable({data_per_game |> filter(team == input$team_team, 
                                     opponent == input$team_opp) |> 
    mutate(date = format(date, "%Y-%m-%d")) |> 
    mutate("home_team" = ifelse(stadium == "h", team, opponent)) |> 
    mutate("away_team" = ifelse(stadium == "a", team, opponent)) |> 
    mutate("home_goals" = ifelse(stadium == "h", scored, conceded)) |> 
    mutate("away_goals" = ifelse(stadium == "a", scored, conceded)) |> 
    select(date, home_team, home_goals, away_goals, away_team)}, digits = 0)

#renderPlot({data_per_club |> group_by(year, league) |>
#                  summarise(avg_exp_goal = mean(exp_goal)) |>
#                  ggplot() + geom_bar(aes(x = league,
#                                          y = avg_exp_goal, 
#                                          fill = league), stat = "Identity") +                                                  facet_wrap(~year, nrow = 3)})

```
> Falta corregir el h2h hay resultados que se voltean + descripción pequeña aca 

### chart 5 

```{r}

renderPlot({data_per_club |> group_by(year, league) |>
                  summarise(avg_exp_goal = mean(xG)) |>
                  ggplot() + geom_bar(aes(x = league,
                                          y = avg_exp_goal, 
                                          fill = league), stat = "Identity") +                                                  facet_wrap(~year, nrow = 3)})

```

row {.tabset}
--------------------------

### chart 4 

```{r}

renderPlot({data_per_club |> group_by(year, league) |>
                  summarise(avg_exp_goal = mean(xG)) |>
                  ggplot() + geom_bar(aes(x = league,
                                          y = avg_exp_goal, 
                                          fill = league), stat = "Identity") +                                                  facet_wrap(~year, nrow = 3)})

```





National League {data-icon="fa-shield"}
==============================

Options {.sidebar}
------------------------

```{r}
selectInput("variable", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))
```


```{r}
selectInput("nation", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))


```

```{r}
selectInput("league", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))

```


column
----------------------------


### summary chart
```{r}



```





### table


```{r}


```


column  {.tabset}
-------------------------------

### chart 1

```{r}


```


### chart 2

```{r}

```

Comparison across leagues {data-orientation=rows data-icon="fa-globe"}
=================================


Options {.sidebar}
------------------------

```{r}
selectInput("year_season", "Choose the season:",
                c("2014/2015" = 2014,
                  "2015/2016" = 2015,
                  "2016/2017" = 2016,
                  "2017/2018" = 2017, 
                  "2018/2019" = 2018,
                  "2019/2020" = 2019))
```



```{r}
# Define the checkbox group input
checkboxGroupInput("select_options", "Select the leagues:", 
                   choices = c("Bundesliga", "EPL", "Serie_A","La_liga" ,"Ligue_1"),
                   selected = c("Bundesliga", "EPL", "Serie_A","La_liga" ,"Ligue_1"))



```


row  {data-orentation=columns data-height=250}
---------------------------------

### tab1 

```{r, fig.width=3}

renderTable({
      data_per_club |> filter(year == input$year_season, position == 1) |> 
      select(year,league, team:pts, exp_pts, exp_goal) }, digits = 0, align = "l", spacing = "s")

```


row 
----------------------------------

### chart 0

```{r}

    renderPlot({data_per_club |> filter(league %in% input$select_options) |> ggplot() + geom_boxplot(aes(league, scored)) +
                 geom_boxplot(aes(league, exp_goal), color = "lightblue") + facet_wrap(~ year) })

```

row
-------------------------------

### chart 1 

```{r, fig.height=3}

data_per_game <-data_per_game |> mutate("date" = as.Date(date, "%Y-%m-%d"))

data_per_game1 <- data_per_game |> 
                  group_by(year, league, team) |> 
                  mutate("match_day" = row_number())



renderPlot({data_per_club |> filter(year == input$year_season, position <= 10, league %in% input$select_options) |> 
                 ggplot() + geom_line(aes(position, goal_diff, color = league))})                                  
# as an alternative focus on a particolar year

#teams_per_league <- data_per_club|> filter(year == 2018, league == "Bundesliga") |> count()




```


### chart 2 


```{r}

renderPlot({data_per_club |> filter(year == input$year_season, league %in% input$select_options) |> 
                 group_by(league) |> summarise(avg_opp_pressure = mean(ppda_coef)) |>
                 ggplot() + geom_bar(aes(league, avg_opp_pressure), stat = "Identity")
})
```


row {.tabset}
---------------------------------

### chart 3 

```{r}



renderPlot({data_per_game1 |> filter(year == input$year_season, league %in% input$select_options ) |> group_by(match_day) |> 
                  summarise(avg_goal_per_day = sum(scored)/10, avg_exp_goal = sum(exp_goal)/10) |>
                    ggplot() + geom_bar(aes(match_day, avg_goal_per_day),  fill="white", stat = "Identity") +    
    theme_dark() + geom_line(aes(match_day, avg_exp_goal), 
                                       color = "red", 
                                       linewidth = 0.5, 
                                       linetype = "dashed")
  
})

```



### average goal scored per match played

```{r}

renderPlot({data_per_game1 |> filter(year == input$year_season, league %in% input$select_options) |> group_by(league, match_day) |> 
    summarise(avg_goal_per_day = sum(scored)/10) |>
               ggplot() + geom_line(aes(match_day, avg_goal_per_day, color = league), linetype = 2) +
               geom_smooth(aes(match_day, avg_goal_per_day, color = league), se = FALSE)
})

```



### average expected goal per game played

```{r}

# try to change the intensity of of the lines so that it's easier to get the trend per league
# fix also the denominator in the division for the exact number of matches played

renderPlot({data_per_game1 |> filter(league %in% input$select_options) |> group_by(year, league, match_day) |>
                                          summarise(avg_exp_goal = sum(exp_goal)/10) |> 
                                          ggplot() + geom_line(aes(match_day, 
                                                                   avg_exp_goal,
                                                                   color = league), linetype = 6, linewidth = 0.3) +
                                          geom_smooth(aes(match_day, avg_exp_goal, color = league), se = FALSE) +
                                          facet_wrap(~ year)})

              
```


### chart 7

```{r}

renderPlot({data_per_club |> filter(year == input$year_season, league %in% input$select_options) |> group_by(league) |>
                 ggplot() + geom_point(aes(scored, deep)) +
                 geom_smooth(aes(scored, deep)) + facet_wrap(~league) })


```



column
-------------------------

### plot 7

```{r}

 renderPlot({
          
     data_per_club |> filter(position == 1, year == input$year_season, league %in% input$select_options) |> 
       ggplot( aes(x = team)) + 
       geom_bar(aes(y = exp_goal), position = "dodge", stat = "Identity") +
       geom_point(aes(y = scored), shape = 17, size = 4, color = "red")
     
   })


```



### chart 6

```{r}

renderPlot({
          
     data_per_club |> filter(position == 1, year == input$year_season, league %in% input$select_options) |> 
       ggplot( aes(x = team)) + 
       geom_bar(aes(y = exp_pts), position = "dodge", stat = "Identity") +
       geom_point(aes(y = pts), shape = 17, size = 4, color = "blue")
     
   })
  
```


