---
title: "Football statistics dashboard"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
runtime: shiny
---

<style>
  .center-text {
    text-align: center;
  }
</style>

<div class="center-text">
  The best interactive dashboard on the market with statistics about football in the top 5 leagues
</div>


```{r setup, include = FALSE}
library(flexdashboard) 
library(tidyverse)
library(ggrepel)
library(DT)
#knitr::opts_chunk$set(fig.width = 5)


#read the data
data1 <- read_csv(file = "data/understat_per_game.csv")
data2 <- read_csv(file = "data/understat.com.csv")

colnames_1 = c("league", "year", "stadium", "exp_goal", "exp_goal_against", 
               "no_pen_exp_goal", "no_pen_exp_goal_against", "deep", 
               "deep_allowed", "scored", "conceded", "exp_pts", "result", "date", 
               "wins", "draws", "loses", "pts", "no_pen_exp_goal_diff", "ppda_coef", 
               "ppda_att", "ppda_def", "oppda_coef", "oppda_att", "oppda_def", 
               "team", "exp_goal_diff", "exp_goal_against_diff", 
               "exp_pts_diff")

colnames(data1) = colnames_1

colnames_2 = c("league", "year", "position", "team", "matches", "wins", "draws", 
               "loses", "scored", "conceded", "pts", "exp_goal", "exp_goal_diff", 
               "no_pen_exp_goal", "exp_goal_against", "exp_goal_against_diff", 
               "no_pen_exp_goal_against", 
               "no_pen_exp_goal_diff", "ppda_coef", "oppda_coef", "deep", 
               "deep_allowed", "exp_pts", "exp_pts_diff")

colnames(data2) = colnames_2

data_per_game <- data1 |> 
  mutate("stadium" = as.factor(stadium), 
         "result" = as.factor(result), 
         "league" = as.factor(league),
         "pts" = as.factor(pts)) |> 
  filter(league != "RFPL")

data_per_club <- data2 |> 
  filter(league != "RFPL") |> 
  mutate("goal_diff" = scored - conceded)

## Check to see no duplicates and the pairing of opponent is done correctly on a 1-1 basis
length(data_per_game$league[duplicated(cbind(data_per_game$league, 
                                             data_per_game$year, 
                                             data_per_game$date, 
                                             data_per_game$scored, 
                                             data_per_game$conceded, 
                                             data_per_game$exp_goal_against, 
                                             data_per_game$exp_goal, 
                                             data_per_game$ppda_coef, 
                                             data_per_game$oppda_coef))])

## Link opponents to each respective match
temp_opponents = data_per_game |> select(league, year, date, scored, 
                                         conceded, exp_goal_against, exp_goal, 
                                         ppda_coef, oppda_coef, "opponent" = team)

data_per_game = data_per_game |> 
  left_join(temp_opponents, by = c("league" = "league", "year" = "year", 
                                   "date" = "date", "scored" = "conceded", 
                                   "conceded" = "scored", 
                                   "exp_goal_against" = "exp_goal", 
                                   "exp_goal" = "exp_goal_against", 
                                   "ppda_coef" = "oppda_coef", 
                                   "oppda_coef" = "ppda_coef"))


```





Team {data-icon="fa-futbol" data-orientation=rows}
==========================


Options {.sidebar}
------------------------

```{r}

#data-icon="fa-table"
selectInput("season", "Choose a competition:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1", 
                  ))
```


```{r}
selectInput("nation", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))


```

```{r}
selectInput("league", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))

```


tabset
-----------------------------------

### tab1 

here we can see how the player


row
---------------------------



### Final Position
```{r fig.width=1, fig.height=0.5}

valueBox(1, caption = "Placement", icon = "fa-thumbs-up")

```

### box 2
```{r fig.width=1, fig.height=1}

gauge(10, min = 0, max = 18, gaugeSectors(
  success = c(11,18), warning = c(5, 10), danger = c(0, 4)))

```
> number of matches won played at "home" and "away"

### box 2
```{r fig.width=1, fig.height=1}

gauge(8, min = 0, max = 18, gaugeSectors(
  success = c(11,18), warning = c(5, 10), danger = c(0, 4)))

```
> the most important summary statistics for the season

### box 3
```{r fig.width=1, fig.height=1}

gauge(18, min = 0, max = 38, gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)))

```
> the most important summary statistics for the season

### box 3
```{r fig.width=1, fig.height=1}

gauge(18, min = 0, max = 38, gaugeSectors(
  success = c(80, 100), warning = c(40, 79), danger = c(0, 39)))

```

> the most important summary statistics for the season

row
----------------------------------

### chart 4 

```{r}

renderPlot({data_per_club |> group_by(year, league) |>
                  summarise(avg_exp_goal = mean(xG)) |>
                  ggplot() + geom_bar(aes(x = league,
                                          y = avg_exp_goal, 
                                          fill = league), stat = "Identity") +                                                  facet_wrap(~year, nrow = 3)})

```
> the most important summary statistics for the season 
> the most important summary statistics for the season

### chart 5 

```{r}

renderPlot({data_per_club |> group_by(year, league) |>
                  summarise(avg_exp_goal = mean(xG)) |>
                  ggplot() + geom_bar(aes(x = league,
                                          y = avg_exp_goal, 
                                          fill = league), stat = "Identity") +                                                  facet_wrap(~year, nrow = 3)})

```

row {.tabset}
--------------------------

### chart 4 

```{r}

renderPlot({data_per_club |> group_by(year, league) |>
                  summarise(avg_exp_goal = mean(xG)) |>
                  ggplot() + geom_bar(aes(x = league,
                                          y = avg_exp_goal, 
                                          fill = league), stat = "Identity") +                                                  facet_wrap(~year, nrow = 3)})

```





National League {data-icon="fa-shield"}
==============================

Options {.sidebar}
------------------------

```{r}
selectInput("variable", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))
```


```{r}
selectInput("nation", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))


```

```{r}
selectInput("league", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))

```


column
----------------------------


### summary chart
```{r}



```





### table


```{r}
renderTable({
      data_per_club |> filter(year == 2017, league == input$variable) |> select(position, team, pts, )
                }, digits = 0)

```


column  {.tabset}
-------------------------------

### chart 1

```{r}


```


### chart 2

```{r}

```

Comparison across leagues {data-orientation=columns, data-icon="fa-globe"}
============================


Options {.sidebar}
------------------------

```{r}
selectInput("season", "Choose a competition:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))
```


```{r}
selectInput("nation", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))


```

```{r}
selectInput("league", "Choose a league:",
                c("Bundesliga" = "Bundesliga",
                  "Premier League" = "EPL",
                  "Serie A" = "Serie_A",
                  "La Liga" = "La_liga", 
                  "Ligue 1" = "Ligue_1"))

```




column 
---------------------------



### chart 1 

```{r, fig.height=3}
data1 <- data_per_club |> filter(year == 2019, league == "La_liga")
 
            renderPlot({ ggplot(data1, aes(missed, scored)) +
                 geom_point(aes(color = team)) +
                 ggrepel::geom_label_repel(aes(label = team), data = data1) })  


```

### chart 2

```{r}
 renderPlot({data_per_club |> 
          filter(year == 2018) |> 
          group_by(league) |>
          ggplot() + geom_line(aes(position, pts, color = league))})
```


column
-------------------------

### chart 3 

```{r}

renderPlot({data_per_game |> filter(year == 2018) |> 
                ggplot() + geom_point(aes(scored, exp_Goal)) + facet_wrap(~league)})

```






